<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日志记录 | 记录生活的每一刻</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // 主色调：深紫色，传达平静与专注
                        secondary: '#EC4899', // 辅助色：粉色，用于强调
                        neutral: {
                            100: '#F9FAFB',
                            200: '#F3F4F6',
                            300: '#E5E7EB',
                            400: '#D1D5DB',
                            500: '#9CA3AF',
                            600: '#6B7280',
                            700: '#4B5563',
                            800: '#1F2937',
                            900: '#111827'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        serif: ['Merriweather', 'Georgia', 'serif']
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'hover': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .transition-height {
                transition: max-height 0.3s ease-in-out;
            }
            .bg-gradient-journal {
                background: linear-gradient(135deg, #f5f7fa 0%, #eef2f7 100%);
            }
            #journal-content:empty:before {
                content: attr(placeholder);
                color: #9CA3AF;
                pointer-events: none;
            }
            .image-container {
                position: relative;
                display: inline-block;
                margin: 0.5rem 0;
            }
            .journal-image {
                max-width: 100%;
                height: auto;
                transition: all 0.3s ease;
            }
            .image-controls {
                position: absolute;
                top: 5px;
                right: 5px;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            .image-container:hover .image-controls {
                opacity: 1;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.14/dist/cropper.min.css">
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.14/dist/cropper.min.js"></script>
</head>

<body class="bg-neutral-100 font-sans text-neutral-800 min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md shadow-sm transition-all duration-300">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-book text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-neutral-800">我的日志</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="relative hidden md:block">
                    <input type="text" id="search-input" 
                           class="pl-10 pr-4 py-2 rounded-full border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all w-48 lg:w-64"
                           placeholder="搜索日志...">
                    <i class="fa fa-search absolute left-4 top-1/2 -translate-y-1/2 text-neutral-500"></i>
                </div>
                
                <button id="mobile-search-btn" class="md:hidden text-neutral-700 hover:text-primary transition-colors">
                    <i class="fa fa-search text-xl"></i>
                </button>
                
                <button id="theme-toggle" class="text-neutral-700 hover:text-primary transition-colors">
                    <i class="fa fa-moon-o text-xl"></i>
                </button>
                
                <button id="undo-btn" class="bg-neutral-200 hover:bg-neutral-300 text-neutral-700 px-3 py-2 rounded-md flex items-center space-x-1 transition-all" disabled>
                    <i class="fa fa-undo"></i>
                    <span>撤销</span>
                </button>
                
                <button id="add-journal-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-full flex items-center space-x-2 transition-all transform hover:scale-105 shadow-sm hover:shadow">
                    <i class="fa fa-plus"></i>
                    <span class="hidden sm:inline">新建日志</span>
                </button>
            </div>
        </div>
        
        <!-- 移动端搜索框 -->
        <div id="mobile-search-container" class="md:hidden px-4 pb-4 hidden">
            <input type="text" id="mobile-search-input" 
                   class="w-full pl-10 pr-4 py-2 rounded-full border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                   placeholder="搜索日志...">
            <i class="fa fa-search absolute left-8 top-[68px] text-neutral-500"></i>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- 欢迎信息和统计 -->
        <section class="mb-10">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                    <h2 id="welcome-message" class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-neutral-800 text-shadow">
                        你好，记录者
                    </h2>
                    <p class="text-neutral-600 mt-1">今天是 <span id="current-date" class="font-medium"></span></p>
                </div>
                
                <div class="mt-4 md:mt-0 grid grid-cols-2 gap-4 w-full md:w-auto">
                    <div class="bg-white rounded-xl p-4 shadow-soft hover:shadow-hover transition-all">
                        <p class="text-neutral-500 text-sm">总日志数</p>
                        <p id="total-journals" class="text-2xl font-bold text-primary">0</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-soft hover:shadow-hover transition-all">
                        <p class="text-neutral-500 text-sm">本月新增</p>
                        <p id="monthly-journals" class="text-2xl font-bold text-secondary">0</p>
                    </div>
                </div>
            </div>
            
            <!-- 快速筛选 -->
            <div class="flex flex-wrap gap-2 mb-6">
                <button class="filter-btn active px-4 py-2 rounded-full bg-primary text-white text-sm font-medium transition-all">
                    全部日志
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-white text-neutral-700 text-sm font-medium hover:bg-neutral-200 transition-all" onclick="window.open('personal.html', '_blank')">
                    个人
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-white text-neutral-700 text-sm font-medium hover:bg-neutral-200 transition-all">
                    工作
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-white text-neutral-700 text-sm font-medium hover:bg-neutral-200 transition-all">
                    学习
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-white text-neutral-700 text-sm font-medium hover:bg-neutral-200 transition-all">
                    灵感
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-white text-neutral-700 text-sm font-medium hover:bg-neutral-200 transition-all">
                    其他
                </button>
            </div>
        </section>
        
        <!-- 日志列表和编辑器区域 -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 日志列表 -->
            <div class="lg:col-span-1 order-2 lg:order-1">
                <div class="bg-white rounded-2xl shadow-soft p-5 h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-neutral-800">日志列表</h3>
                        <div class="flex space-x-2">
                            <button id="sort-btn" class="text-neutral-500 hover:text-primary transition-colors">
                                <i class="fa fa-sort"></i>
                            </button>
                            <button id="view-toggle" class="text-neutral-500 hover:text-primary transition-colors">
                                <i class="fa fa-th-large"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="journals-list" class="space-y-3 max-h-[calc(100vh-320px)] overflow-y-auto pr-2">
                        <!-- 日志条目将通过JavaScript动态生成 -->
                        <div class="text-center text-neutral-500 py-10">
                            <i class="fa fa-book-open text-4xl mb-3 opacity-30"></i>
                            <p>还没有日志，点击"新建日志"开始记录吧</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 日志编辑器/查看器 -->
            <div class="lg:col-span-2 order-1 lg:order-2">
                <div class="bg-white rounded-2xl shadow-soft p-5 min-h-[400px]">
                    <div id="empty-state" class="text-center py-16">
                        <i class="fa fa-pencil-square-o text-5xl text-neutral-300 mb-4"></i>
                        <h3 class="text-xl font-medium text-neutral-700 mb-2">选择或创建一篇日志</h3>
                        <p class="text-neutral-500 max-w-md mx-auto">点击"新建日志"按钮开始记录你的想法、感受或日常</p>
                    </div>
                    
                    <div id="journal-editor" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <input type="text" id="journal-title" placeholder="输入标题..."
                                       class="text-2xl font-bold w-full bg-transparent border-b border-transparent focus:border-primary focus:outline-none transition-colors">
                                <p id="journal-date" class="text-neutral-500 text-sm mt-1"></p>
                                <div class="mt-2 flex items-center">
                                    <label for="journal-category" class="text-neutral-600 text-sm mr-2">分类:</label>
                                    <select id="journal-category" class="bg-neutral-100 border border-neutral-300 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                                        <option value="personal">个人</option>
                                        <option value="work">工作</option>
                                        <option value="study">学习</option>
                                        <option value="inspiration">灵感</option>
                                        <option value="other">其他</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button id="save-journal" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all">
                                    <i class="fa fa-save mr-1"></i> 保存
                                </button>
                                <button id="delete-journal" class="bg-neutral-200 hover:bg-red-100 text-neutral-700 hover:text-red-600 px-4 py-2 rounded-lg transition-all">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div id="journal-content" contenteditable="true" placeholder="开始记录你的想法..."
                                      class="w-full min-h-[400px] p-4 bg-neutral-50 rounded-xl border border-neutral-200 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary resize-none transition-all"></div>
                        </div>
                        
                        <div class="flex justify-between items-center text-sm text-neutral-500">
                            <p id="word-count">0 个字</p>
                            <div class="flex space-x-3">
                                <button class="format-btn px-2 py-1 hover:bg-neutral-100 rounded transition-colors" data-command="bold">
                                    <i class="fa fa-bold"></i>
                                </button>
                                <button class="format-btn px-2 py-1 hover:bg-neutral-100 rounded transition-colors" data-command="italic">
                                    <i class="fa fa-italic"></i>
                                </button>
                                <button class="format-btn px-2 py-1 hover:bg-neutral-100 rounded transition-colors" data-command="underline">
                                    <i class="fa fa-underline"></i>
                                </button>
                                <button class="format-btn px-2 py-1 hover:bg-neutral-100 rounded transition-colors" data-command="insertUnorderedList">
                                    <i class="fa fa-list-ul"></i>
                                </button>
                                <button class="format-btn px-2 py-1 hover:bg-neutral-100 rounded transition-colors" data-command="insertOrderedList">
                                    <i class="fa fa-list-ol"></i>
                                </button>
                                <!-- 新增图片上传按钮 -->
                                <button id="upload-image" class="format-btn px-2 py-1 hover:bg-neutral-100 rounded transition-colors">
                                    <i class="fa fa-picture-o"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-neutral-200 py-6 mt-10">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-2 mb-4 md:mb-0">
                    <i class="fa fa-book text-primary"></i>
                    <span class="font-medium">我的日志</span>
                </div>
                <p class="text-neutral-500 text-sm">© <span id="current-year"></span> 我的日志 | 保护你的隐私，所有数据存储在本地</p>
                <div class="flex space-x-4 mt-4 md:mt-0">
                    <button class="text-neutral-500 hover:text-primary transition-colors">
                        <i class="fa fa-question-circle"></i>
                    </button>
                    <button class="text-neutral-500 hover:text-primary transition-colors">
                        <i class="fa fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>
    </footer>

    <!-- 确认删除对话框 -->
    <div id="delete-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 transform transition-all scale-95 opacity-0" id="modal-content">
            <div class="text-center mb-4">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-500 mb-4">
                    <i class="fa fa-trash text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-neutral-800">确认删除</h3>
                <p class="text-neutral-600 mt-2">你确定要删除这篇日志吗？此操作无法撤销。</p>
            </div>
            <div class="flex space-x-3 mt-6">
                <button id="cancel-delete" class="flex-1 px-4 py-3 rounded-lg border border-neutral-300 text-neutral-700 hover:bg-neutral-100 transition-all">
                    取消
                </button>
                <button id="confirm-delete" class="flex-1 px-4 py-3 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-all">
                    确认删除
                </button>
            </div>
        </div>
    </div>

    <!-- 成功提示 -->
    <div id="toast" class="fixed bottom-6 right-6 bg-neutral-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all z-50 flex items-center space-x-2">
        <i class="fa fa-check-circle text-green-400"></i>
        <span id="toast-message">操作成功</span>
    </div>

    <script>
        // 全局变量
        let journals = [];
        let currentJournalId = null;
        let isDarkMode = false;
        
        // DOM 元素
        const journalsListEl = document.getElementById('journals-list');
        const journalEditorEl = document.getElementById('journal-editor');
        const emptyStateEl = document.getElementById('empty-state');
        const journalTitleEl = document.getElementById('journal-title');
        const journalContentEl = document.getElementById('journal-content');
        const journalDateEl = document.getElementById('journal-date');
const journalCategoryEl = document.getElementById('journal-category');
const wordCountEl = document.getElementById('word-count');
        const totalJournalsEl = document.getElementById('total-journals');
        const monthlyJournalsEl = document.getElementById('monthly-journals');
        const currentDateEl = document.getElementById('current-date');
        const currentYearEl = document.getElementById('current-year');
        const searchInputEl = document.getElementById('search-input');
        const mobileSearchInputEl = document.getElementById('mobile-search-input');
        const mobileSearchBtnEl = document.getElementById('mobile-search-btn');
        const mobileSearchContainerEl = document.getElementById('mobile-search-container');
        const addJournalBtnEl = document.getElementById('add-journal-btn');
        const saveJournalBtnEl = document.getElementById('save-journal');
        const deleteJournalBtnEl = document.getElementById('delete-journal');
        const deleteModalEl = document.getElementById('delete-modal');
        const modalContentEl = document.getElementById('modal-content');
        const cancelDeleteBtnEl = document.getElementById('cancel-delete');
        const confirmDeleteBtnEl = document.getElementById('confirm-delete');

// 撤销功能相关变量
let historyStack = [];
let currentHistoryIndex = -1;

const toastEl = document.getElementById('toast');
        const toastMessageEl = document.getElementById('toast-message');
        const themeToggleEl = document.getElementById('theme-toggle');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const formatBtns = document.querySelectorAll('.format-btn');
        
        // 初始化
        function init() {
            // 加载本地存储的日志
            loadJournals();
            
            // 更新UI
            renderJournals();
            updateStats();
            updateDateDisplay();
            
            // 绑定事件监听器
            bindEventListeners();
        }
        
        // 从本地存储加载日志
        function loadJournals() {
            const savedJournals = localStorage.getItem('journals');
            if (savedJournals) {
                journals = JSON.parse(savedJournals);
            }
        }
        
        // 保存日志到本地存储
        function saveJournals() {
            localStorage.setItem('journals', JSON.stringify(journals));
            updateStats();
        }
        
        // 渲染日志列表
        function renderJournals(filter = 'all', searchTerm = '') {
            journalsListEl.innerHTML = '';
            
            if (journals.length === 0) {
                journalsListEl.innerHTML = `
                    <div class="text-center text-neutral-500 py-10">
                        <i class="fa fa-book-open text-4xl mb-3 opacity-30"></i>
                        <p>还没有日志，点击"新建日志"开始记录吧</p>
                    </div>
                `;
                return;
            }
            
            // 过滤和排序日志
            let filteredJournals = [...journals];
            
            // 按日期排序（最新的在前）
            filteredJournals.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // 应用过滤器
            if (filter === 'personal') {
                filteredJournals = filteredJournals.filter(journal => journal.category === 'personal');
            } else if (filter === 'work') {
                filteredJournals = filteredJournals.filter(journal => journal.category === 'work');
            } else if (filter === 'study') {
                filteredJournals = filteredJournals.filter(journal => journal.category === 'study');
            } else if (filter === 'inspiration') {
                filteredJournals = filteredJournals.filter(journal => journal.category === 'inspiration');
            } else if (filter === 'other') {
                filteredJournals = filteredJournals.filter(journal => journal.category === 'other');
            }
            
            // 按日期排序（最新的在前）
            filteredJournals.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // 应用过滤器
            if (filter === 'today') {
                const today = new Date().toDateString();
                filteredJournals = filteredJournals.filter(journal => 
                    new Date(journal.createdAt).toDateString() === today
                );
            } else if (filter === 'thisWeek') {
                const now = new Date();
                const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                filteredJournals = filteredJournals.filter(journal => 
                    new Date(journal.createdAt) >= startOfWeek
                );
            } else if (filter === 'thisMonth') {
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredJournals = filteredJournals.filter(journal => 
                    new Date(journal.createdAt) >= startOfMonth
                );
            }
            
            // 应用搜索
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredJournals = filteredJournals.filter(journal => 
                    journal.title.toLowerCase().includes(term) || 
                    journal.content.toLowerCase().includes(term)
                );
            }
            
            if (filteredJournals.length === 0) {
                journalsListEl.innerHTML = `
                    <div class="text-center text-neutral-500 py-10">
                        <i class="fa fa-search text-4xl mb-3 opacity-30"></i>
                        <p>没有找到匹配的日志</p>
                    </div>
                `;
                return;
            }
            
            // 创建日志条目元素
            filteredJournals.forEach(journal => {
                const journalEl = document.createElement('div');
                journalEl.className = `p-3 rounded-xl hover:bg-neutral-50 transition-all cursor-pointer ${currentJournalId === journal.id ? 'bg-primary/10 border-l-4 border-primary' : ''}`;
                journalEl.dataset.id = journal.id;
                
                // 截断内容，只显示前100个字符
                const truncatedContent = journal.content.length > 100 
                    ? journal.content.substring(0, 100) + '...' 
                    : journal.content;
                
                // 格式化日期
                const formattedDate = formatDate(journal.createdAt);
                
                journalEl.innerHTML = `
                    <h4 class="font-medium text-neutral-800 mb-1 truncate">${journal.title || '无标题'}</h4>
                    <p class="text-neutral-600 text-sm line-clamp-2 mb-2">${truncatedContent}</p>
                    <p class="text-neutral-400 text-xs">${formattedDate}</p>
                `;
                
                journalEl.addEventListener('click', () => openJournal(journal.id));
                journalsListEl.appendChild(journalEl);
            });
        }
        
        // 打开日志进行编辑或查看
        function openJournal(id) {
            const journal = journals.find(j => j.id === id);
            if (!journal) return;
            
            currentJournalId = id;
            
            // 填充编辑器
            journalTitleEl.value = journal.title || '';
            journalContentEl.value = journal.content || '';
            document.getElementById('journal-category').value = journal.category || 'other';
            journalDateEl.textContent = `最后编辑: ${formatDate(journal.updatedAt || journal.createdAt)}`;
            
            // 清除现有图片预览
            const existingPreviews = document.querySelectorAll('.image-preview');
            existingPreviews.forEach(preview => preview.remove());
            
            // 新增：显示图片预览
            if (journal.images && journal.images.length > 0) {
                showImagePreview(journal.images[journal.images.length - 1]);
            }

            // 更新字数统计
            updateWordCount();
            
            // 初始化历史记录
            historyStack = [];
            currentHistoryIndex = -1;
            saveToHistory(); // 保存初始状态
            
            // 显示编辑器，隐藏空状态
            journalEditorEl.classList.remove('hidden');
            emptyStateEl.classList.add('hidden');
            
            // 更新列表中选中的日志样式
            renderJournals();
            
            // 聚焦到内容区域
            journalContentEl.focus();
        }
        
        // 创建新日志
        function createNewJournal() {
            const newJournal = {
                id: Date.now().toString(),
                title: '',
                content: '',
                category: 'other', // 默认分类为其他
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                images: [] // 新增：图片数组
            };
            
            journals.unshift(newJournal);
            saveJournals();
            openJournal(newJournal.id);
            renderJournals();
            
            // 聚焦到标题
            journalTitleEl.focus();
        }
        
        // 保存当前日志
        function saveCurrentJournal() {
            if (!currentJournalId) return;
            
            const journal = journals.find(j => j.id === currentJournalId);
            if (!journal) return;
            
            // 更新日志内容
            journal.title = journalTitleEl.value.trim();
            journal.content = journalContentEl.value.trim();
            journal.category = document.getElementById('journal-category').value;
            journal.updatedAt = new Date().toISOString();
            
            // 保存到本地存储
            saveJournals();
            
            // 更新UI
            renderJournals();
            journalDateEl.textContent = `最后编辑: ${formatDate(journal.updatedAt)}`;
            
            // 显示成功提示
            showToast('日志已保存');
        }
        
        // 删除当前日志
        function deleteCurrentJournal() {
            if (!currentJournalId) return;
            
            // 从数组中移除日志
            journals = journals.filter(j => j.id !== currentJournalId);
            
            // 保存更改
            saveJournals();
            
            // 重置编辑器
            currentJournalId = null;
            journalTitleEl.value = '';
            journalContentEl.value = '';
            
            // 更新UI
            renderJournals();
            journalEditorEl.classList.add('hidden');
            emptyStateEl.classList.remove('hidden');
            
            // 关闭模态框
            closeDeleteModal();
            
            // 显示成功提示
            showToast('日志已删除');
        }
        
        // 更新统计信息
        function updateStats() {
            // 总日志数
            totalJournalsEl.textContent = journals.length;
            
            // 本月新增日志数
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthlyCount = journals.filter(journal => {
                const date = new Date(journal.createdAt);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            }).length;
            
            monthlyJournalsEl.textContent = monthlyCount;
        }
        
        // 更新日期显示
        function updateDateDisplay() {
            const now = new Date();
            
            // 格式化当前日期为 "YYYY年MM月DD日 星期X"
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            currentDateEl.textContent = now.toLocaleDateString('zh-CN', options);
            
            // 设置当前年份
            currentYearEl.textContent = now.getFullYear();
        }
        
        // 更新字数统计
        function updateWordCount() {
            const content = journalContentEl.value;
            const wordCount = content.length;
            wordCountEl.textContent = `${wordCount} 个字`;
        }
        
        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            
            // 今天
            if (date.toDateString() === now.toDateString()) {
                return `今天 ${date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}`;
            }
            
            // 昨天
            const yesterday = new Date(now);
            yesterday.setDate(now.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return `昨天 ${date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}`;
            }
            
            // 今年
            if (date.getFullYear() === now.getFullYear()) {
                return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
            }
            
            // 其他年份
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        // 显示删除确认模态框
        function showDeleteModal() {
            deleteModalEl.classList.remove('hidden');
            // 触发动画
            setTimeout(() => {
                modalContentEl.classList.remove('scale-95', 'opacity-0');
                modalContentEl.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        // 关闭删除确认模态框
        function closeDeleteModal() {
            modalContentEl.classList.remove('scale-100', 'opacity-100');
            modalContentEl.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                deleteModalEl.classList.add('hidden');
            }, 300);
        }
        
        // 显示提示消息
        function showToast(message) {
            toastMessageEl.textContent = message;
            toastEl.classList.remove('translate-y-20', 'opacity-0');
            toastEl.classList.add('translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                toastEl.classList.remove('translate-y-0', 'opacity-100');
                toastEl.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
        
        // 切换主题
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                themeToggleEl.innerHTML = '<i class="fa fa-sun-o text-xl"></i>';
                // 可以在这里添加更多暗色模式样式
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleEl.innerHTML = '<i class="fa fa-moon-o text-xl"></i>';
                // 可以在这里移除暗色模式样式
            }
        }
        
        // 应用文本格式化
        function formatText(command) {
            document.execCommand(command, false, null);
            journalContentEl.focus();
            updateWordCount();
        }

        // 新增：处理图片上传
        function handleImageUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imageData = event.target.result;
                    const imageId = Date.now().toString();
                    
                    // 创建图片元素
                    const img = document.createElement('img');
                    img.src = imageData;
                    img.className = 'journal-image border border-neutral-200 rounded-lg';
                    img.dataset.imageId = imageId;
                    img.style.maxWidth = '100%';
                    img.style.width = '50%';
                    
                    // 创建控制按钮容器
                    const controls = document.createElement('div');
                    controls.className = 'image-controls bg-white/80 backdrop-blur-sm p-1 rounded shadow flex space-x-1';
                    controls.innerHTML = `
            <button class="image-rotate-left text-xs px-2 py-1 hover:bg-neutral-100 rounded-md transition-colors" data-action="rotate-left"><i class="fa fa-rotate-left"></i></button>
            <button class="image-rotate-right text-xs px-2 py-1 hover:bg-neutral-100 rounded-md transition-colors" data-action="rotate-right"><i class="fa fa-rotate-right"></i></button>
            <button class="image-zoom-in text-xs px-2 py-1 hover:bg-neutral-100 rounded-md transition-colors" data-action="zoom-in"><i class="fa fa-search-plus"></i></button>
            <button class="image-zoom-out text-xs px-2 py-1 hover:bg-neutral-100 rounded-md transition-colors" data-action="zoom-out"><i class="fa fa-search-minus"></i></button>
            <button class="image-delete text-xs px-2 py-1 hover:bg-red-100 hover:text-red-500 rounded-md transition-colors" data-action="delete"><i class="fa fa-trash"></i></button>
        `;
                    
                    // 创建图片容器
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container my-2 relative inline-block resize overflow-auto';
                    imageContainer.style.minWidth = '100px';
                    imageContainer.style.minHeight = '100px';
                    
                    // 添加调整尺寸手柄
            const resizeHandle = document.createElement('div');
            // 修改手柄默认样式为隐藏
            resizeHandle.className = 'absolute bottom-0 right-0 w-6 h-6 bg-blue-500 cursor-se-resize opacity-0 border-t border-l border-white transition-all duration-300 z-10';
            imageContainer.appendChild(resizeHandle);

            // 添加图片点击显示/隐藏手柄的功能
            let handleVisible = false;
            imageContainer.addEventListener('click', (e) => {
                // 防止事件冒泡影响其他元素
                // e.stopPropagation();
                handleVisible = !handleVisible;
                resizeHandle.style.opacity = handleVisible ? '0.8' : '0';
                // 显示时添加缩放效果增强可见性
                resizeHandle.style.transform = handleVisible ? 'scale(1.2)' : 'scale(1)';
            });

            // 点击页面其他区域隐藏手柄
            document.addEventListener('click', () => {
                handleVisible = false;
                resizeHandle.style.opacity = '0';
            });
            
            // 新增：添加拖拽调整大小功能
            let isResizing = false;
            let startX, startY, startWidth, startHeight;

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(document.defaultView.getComputedStyle(imageContainer).width, 10);
                startHeight = parseInt(document.defaultView.getComputedStyle(imageContainer).height, 10);

                // 添加事件监听器
                document.addEventListener('mousemove', resizeImage);
                document.addEventListener('mouseup', stopResize);

                // 防止拖动时选中文本
                e.preventDefault();
                e.stopPropagation();
            });

            function resizeImage(e) {
                if (!isResizing) return;

                const width = startWidth + (e.clientX - startX);
                const height = startHeight + (e.clientY - startY);

                // 设置最小尺寸
                if (width > 100 && height > 100) {
                    imageContainer.style.width = `${width}px`;
                    imageContainer.style.height = `${height}px`;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'contain';
                }

                e.preventDefault();
                e.stopPropagation();
            }

            function stopResize() {
                isResizing = false;
                // 调整结束后隐藏手柄
                handleVisible = false;
                resizeHandle.style.opacity = '0';
                // 移除事件监听器
                document.removeEventListener('mousemove', resizeImage);
                document.removeEventListener('mouseup', stopResize);
            }
            
            imageContainer.appendChild(img);
            imageContainer.appendChild(controls);
                    
                    // 将图片容器插入到编辑器中
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        range.deleteContents();
                        range.insertNode(imageContainer);
                        // 在图片后插入一个换行
                        const br = document.createElement('br');
                        range.setStartAfter(imageContainer);
                        range.setEndAfter(imageContainer);
                        range.insertNode(br);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    } else {
                        journalContentEl.appendChild(imageContainer);
                        journalContentEl.appendChild(document.createElement('br'));
                    }
                    
                    // 更新日志内容
                    updateWordCount();
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        // 新增：显示图片预览
        function showImagePreview(imageData) {
            // 清除现有预览
            const existingPreviews = document.querySelectorAll('.image-preview');
            existingPreviews.forEach(preview => preview.remove());
            
            // 创建图片预览元素
            const previewContainer = document.createElement('div');
            previewContainer.className = 'image-preview mt-4 mb-4 border border-neutral-200 rounded-lg p-2 bg-neutral-50';
            previewContainer.innerHTML = `
                <div class="cropper-container">
                    <img id="preview-image" src="${imageData}" class="max-w-full h-64 object-contain rounded" alt="日志图片">
                </div>
                <div class="image-controls mt-2 flex justify-center gap-2">
                    <button class="rotate-left btn btn-sm btn-neutral">左转</button>
                    <button class="rotate-right btn btn-sm btn-neutral">右转</button>
                    <button class="zoom-in btn btn-sm btn-neutral">放大</button>
                    <button class="zoom-out btn btn-sm btn-neutral">缩小</button>
                    <button class="crop btn btn-sm btn-primary">裁剪</button>
                    <button class="delete btn btn-sm btn-danger">删除</button>
                </div>
            `;
            
            // 将预览添加到编辑器下方
            const contentContainer = journalContentEl.parentElement;
            contentContainer.insertBefore(previewContainer, journalContentEl.nextSibling);
            
            // 初始化Cropper
            const image = previewContainer.querySelector('#preview-image');
            let cropper;
            function initCropper() {
                if (cropper) cropper.destroy();
                cropper = new Cropper(image, {
                    aspectRatio: NaN,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    cropBoxMovable: true,
                    cropBoxResizable: true
                });
            }
            initCropper();
            
            // 绑定控制按钮事件
            previewContainer.querySelector('.rotate-left').addEventListener('click', () => {
                cropper.rotate(-90);
            });
            
            previewContainer.querySelector('.rotate-right').addEventListener('click', () => {
                cropper.rotate(90);
            });
            
            previewContainer.querySelector('.zoom-in').addEventListener('click', () => {
                cropper.zoom(0.1);
            });
            
            previewContainer.querySelector('.zoom-out').addEventListener('click', () => {
                cropper.zoom(-0.1);
            });
            
            previewContainer.querySelector('.crop').addEventListener('click', () => {
                const croppedCanvas = cropper.getCroppedCanvas();
                const croppedImageData = croppedCanvas.toDataURL('image/jpeg');
                
                // 更新预览图
                image.src = croppedImageData;
                cropper.destroy();
                // 重新初始化Cropper以应用新图片
                new Cropper(image, {
                    aspectRatio: NaN,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    cropBoxMovable: true,
                    cropBoxResizable: true
                });
                
                // 更新日志内容中的图片
                const imageElements = journalContentEl.querySelectorAll('img');
                if (imageElements.length > 0) {
                    imageElements[imageElements.length - 1].src = croppedImageData;
                }
            });
            
            previewContainer.querySelector('.delete').addEventListener('click', () => {
                previewContainer.remove();
                // 从日志内容中删除图片
                const imageElements = journalContentEl.querySelectorAll('img');
                if (imageElements.length > 0) {
                    const lastImage = imageElements[imageElements.length - 1];
                    const container = lastImage.parentElement;
                    if (container.classList.contains('image-container')) {
                        container.remove();
                    } else {
                        lastImage.remove();
                    }
                    updateWordCount();
                }
            });
        }

        // 绑定事件监听器
        function bindEventListeners() {
            // 添加新日志
            addJournalBtnEl.addEventListener('click', createNewJournal);
            
            // 保存日志
            saveJournalBtnEl.addEventListener('click', saveCurrentJournal);
            
            // 按Ctrl+S保存
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (currentJournalId) {
                        saveCurrentJournal();
                    }
                }
            });
            
            // 删除日志相关
            deleteJournalBtnEl.addEventListener('click', showDeleteModal);
            cancelDeleteBtnEl.addEventListener('click', closeDeleteModal);
            confirmDeleteBtnEl.addEventListener('click', deleteCurrentJournal);
            
            // 点击模态框外部关闭
            deleteModalEl.addEventListener('click', (e) => {
                if (e.target === deleteModalEl) {
                    closeDeleteModal();
                }
            });
            
            // 字数统计
            journalContentEl.addEventListener('input', (e) => {
                updateWordCount();
                saveToHistory();
            });
            journalTitleEl.addEventListener('input', (e) => {
                updateWordCount();
                saveToHistory();
            });
            
            // 搜索
            searchInputEl.addEventListener('input', (e) => {
                const filter = getActiveFilter();
                renderJournals(filter, e.target.value);
            });
            
            mobileSearchInputEl.addEventListener('input', (e) => {
                const filter = getActiveFilter();
                renderJournals(filter, e.target.value);
            });
            
            // 移动端搜索框切换
            mobileSearchBtnEl.addEventListener('click', () => {
                mobileSearchContainerEl.classList.toggle('hidden');
                if (!mobileSearchContainerEl.classList.contains('hidden')) {
                    mobileSearchInputEl.focus();
                }
            });
            
            // 主题切换
            themeToggleEl.addEventListener('click', toggleTheme);
            
            // 过滤器
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // 更新按钮样式
                    filterBtns.forEach(b => {
                        b.classList.remove('active', 'bg-primary', 'text-white');
                        b.classList.add('bg-white', 'text-neutral-700');
                    });
                    btn.classList.add('active', 'bg-primary', 'text-white');
                    btn.classList.remove('bg-white', 'text-neutral-700');
                    
                    // 获取搜索词
                    const searchTerm = searchInputEl.value || mobileSearchInputEl.value;
                    
                    // 确定过滤器类型
                    let filter = 'all';
                    if (btn.textContent.includes('个人')) filter = 'personal';
                    else if (btn.textContent.includes('工作')) filter = 'work';
                    else if (btn.textContent.includes('学习')) filter = 'study';
                    else if (btn.textContent.includes('灵感')) filter = 'inspiration';
                    else if (btn.textContent.includes('其他')) filter = 'other';
                    
                    // 应用过滤
                    renderJournals(filter, searchTerm);
                });
            });
            
            // 文本格式化按钮
            formatBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const command = btn.dataset.command;
                    formatText(command);
                });
            });

            // 新增：图片控制按钮事件委托
            journalContentEl.addEventListener('click', (e) => {
                const action = e.target.closest('[data-action]')?.dataset.action;
                if (!action) return;

                const imageContainer = e.target.closest('.image-container');
                if (!imageContainer) return;

                const img = imageContainer.querySelector('img');
                if (!img) return;

                switch(action) {
                case 'rotate-left':
                    const currentRotationLeft = parseInt(img.dataset.rotation || 0);
                    img.dataset.rotation = (currentRotationLeft - 90) % 360;
                    img.style.transform = `rotate(${img.dataset.rotation}deg)`;
                    break;
                case 'rotate-right':
                    const currentRotationRight = parseInt(img.dataset.rotation || 0);
                    img.dataset.rotation = (currentRotationRight + 90) % 360;
                    img.style.transform = `rotate(${img.dataset.rotation}deg)`;
                    break;
                case 'zoom-in':
                    img.style.width = (parseInt(img.style.width) || 50) + 10 + '%';
                    break;
                case 'zoom-out':
                    img.style.width = Math.max(20, (parseInt(img.style.width) || 50) - 10) + '%';
                    break;
                case 'delete':
                    imageContainer.remove();
                    updateWordCount();
                    break;
            }
            });

            // 新增：绑定图片上传按钮事件
            document.getElementById('upload-image').addEventListener('click', handleImageUpload);
            
            // 撤销按钮事件
            document.getElementById('undo-btn').addEventListener('click', undoLastAction);
        }

        // 获取当前激活的过滤器
        function getActiveFilter() {
            const activeBtn = document.querySelector('.filter-btn.active');
            if (!activeBtn) return 'all';
            
            if (activeBtn.textContent.includes('个人')) return 'personal';
            if (activeBtn.textContent.includes('工作')) return 'work';
            if (activeBtn.textContent.includes('学习')) return 'study';
            if (activeBtn.textContent.includes('灵感')) return 'inspiration';
            if (activeBtn.textContent.includes('其他')) return 'other';
            return 'all';
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', init);

        // 撤销功能相关函数
        function saveToHistory() {
            if (currentHistoryIndex < historyStack.length - 1) {
                historyStack = historyStack.slice(0, currentHistoryIndex + 1);
            }
            
            const currentState = {
                title: journalTitleEl.value,
                content: journalContentEl.innerHTML,
                category: journalCategoryEl.value
            };
            
            historyStack.push(currentState);
            currentHistoryIndex = historyStack.length - 1;
            updateUndoButton();
        }
        
        function undoLastAction() {
            if (currentHistoryIndex > 0) {
                currentHistoryIndex--;
                const previousState = historyStack[currentHistoryIndex];
                
                journalTitleEl.value = previousState.title;
                journalContentEl.innerHTML = previousState.content;
                journalCategoryEl.value = previousState.category;
                
                updateWordCount();
                updateUndoButton();
            }
        }
        
        function updateUndoButton() {
            const undoBtn = document.getElementById('undo-btn');
            undoBtn.disabled = currentHistoryIndex <= 0;
        }
    </script>
</body>
</html>
